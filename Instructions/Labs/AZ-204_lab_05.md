---
lab:
  az204Title: 'Lab 05: Deploy compute workloads by using images and containers'
  az204Module: 'Module 05: Implement IaaS solutions'
---

# <a name="lab-05-deploy-compute-workloads-by-using-images-and-containers"></a>实验室 05：使用映像和容器部署计算工作负载

## <a name="microsoft-azure-user-interface"></a>Microsoft Azure 用户接口

Given the dynamic nature of Microsoft cloud tools, you might experience Azure UI changes that occur after this training content's development. As a result, the lab instructions and lab steps might not align correctly.

Microsoft updates this training course when the community alerts us to needed changes. However, cloud updates occur frequently, so you might encounter UI changes before this training content updates. <bpt id="p1">**</bpt>If this occurs, adapt to the changes, and then work through them in the labs as needed.<ept id="p1">**</ept>

## <a name="instructions"></a>说明

### <a name="before-you-start"></a>开始之前

#### <a name="sign-in-to-the-lab-environment"></a>登录到实验室环境

使用以下凭据登录到 Windows 10 虚拟机 (VM)：

-   用户名：Admin

-   密码：Pa55w.rd

> **注意**：你的讲师将提供连接到虚拟实验室环境的说明。

#### <a name="review-the-installed-applications"></a>查看已安装的应用程序

Find the taskbar on your Windows 10 desktop. The taskbar contains the icons for the applications that you'll use in this lab, including:

-   Microsoft Edge

-   文件资源浏览器

## <a name="architecture-diagram"></a>体系结构关系图

![描述使用映像和容器部署计算工作负载的体系结构关系图](./media/Lab05-Diagram.png)

### <a name="exercise-1-create-a-vm-by-using-the-azure-command-line-interface-cli"></a>练习 1：使用 Azure 命令行接口 (CLI) 创建 VM

#### <a name="task-1-open-the-azure-portal"></a>任务 1：打开 Azure 门户

1.  在任务栏上，选择 Microsoft Edge 图标。

1. 在打开的浏览器窗口中，导航到 Azure 门户 (<https://portal.azure.com>)，然后使用你将用于此实验的帐户登录。

   > 鉴于 Microsoft 云工具的动态特性，Azure UI 在此培训内容开发后可能会发生更改。

#### <a name="task-2-create-a-resource-group"></a>任务 2：创建资源组

1.  在 Azure 门户的导航窗格中，使用“搜索资源、服务和文档”文本框搜索“资源组”，然后在结果列表中，选择“资源组”。

1.  在“资源组”边栏选项卡中，选择“创建”。

1.  在“创建资源组”边栏选项卡的“基本信息”选项卡上，执行以下操作，然后选择“查看 + 创建”  ：

    | 设置 | 操作 |
    | -- | -- |
    | “订阅”下拉列表 | 保留默认值  |
    | “资源组”文本框 | 输入“ContainerCompute” |
    | “区域”下拉列表 | 选择“(US)美国东部” |

    以下屏幕截图显示了“创建资源组”边栏选项卡上配置的设置。

    ![“创建资源组”边栏选项卡](./media/l05_create_a_resource_group.png)

1.  在“查看 + 创建”选项卡中，查看在上述步骤中选择的选项。

1.  选择“创建”以使用指定的配置创建资源组。  

    > **注意**：等待创建任务完成后再继续本实验。

#### <a name="task-3-open-azure-cloud-shell"></a>任务 3：打开 Azure Cloud Shell

1.  因此，实验说明和实验步骤可能无法正确对应。

    > **注意**：“Cloud Shell”图标使用大于符号 (\>) 和下划线字符 (\_) 表示。

    > <bpt id="p1">**</bpt>Note<ept id="p1">**</ept>: If this is the first time you're starting <bpt id="p2">**</bpt>Cloud Shell<ept id="p2">**</ept>, when prompted to select either <bpt id="p3">**</bpt>Bash<ept id="p3">**</ept> or <bpt id="p4">**</bpt>PowerShell<ept id="p4">**</ept>, select <bpt id="p5">**</bpt>Bash<ept id="p5">**</ept>. When you're presented with the <bpt id="p1">**</bpt>You have no storage mounted<ept id="p1">**</ept> message, select the subscription you're using in this lab, and then select <bpt id="p2">**</bpt>Create storage<ept id="p2">**</ept>.

1.  在门户的“Cloud Shell”命令提示符处，运行以下命令，以查看 Azure CLI 工具的版本：

    ```
    az --version
    ```

#### <a name="task-4-use-the-azure-cli-commands"></a>任务 4：使用 Azure CLI 命令

1.  运行以下命令以获取 CLI 根级别的子组和命令列表：

    ```
    az --help
    ```

1.  运行以下命令以获取 Azure 虚拟机子组和命令列表：

    ```
    az vm --help
    ```

1.  运行以下命令，以查看“创建虚拟机”命令的参数和示例列表：

    ```
    az vm create --help
    ```

1.  运行以下命令，以使用下列设置创建新的虚拟机，请务必记录系统要求在下方创建的密码，稍后在实验室中将需要使用此密码来访问虚拟机：

    -   资源组：ContainerCompute

    -   名称：quickvm

    -   映像:**Debian**

    -   管理员用户名：student

    -   管理员密码：\<CreateYourPassword\>

    > 注意：将以下命令中的 `<CreateYourPassword>` 替换为自己的密码。

    ```
    az vm create --resource-group ContainerCompute --name quickvm --image Debian --admin-username student --admin-password <CreateYourPassword>
    ```

    > 我们发现社区进行了必要更改时，Microsoft 会更新此培训课程。

1.  运行以下命令，以获取包含有关新创建 VM 的各种元数据的更详细 JSON 文件：

    ```
    az vm show --resource-group ContainerCompute --name quickvm
    ```

1.  运行以下命令，以列出与 VM 关联的所有 IP 地址：

    ```
    az vm list-ip-addresses --resource-group ContainerCompute --name quickvm
    ```

1.  运行以下命令以筛选输出，以便只返回第一个 IP 地址值：

    ```
    az vm list-ip-addresses --resource-group ContainerCompute --name quickvm --query '[].{ip:virtualMachine.network.publicIpAddresses[0].ipAddress}' --output tsv
    ```

1.  运行以下命令，以将上一个命令的结果存储在名为 ipAddress 的新 Bash Shell 变量中：

    ```
    ipAddress=$(az vm list-ip-addresses --resource-group ContainerCompute --name quickvm --query '[].{ip:virtualMachine.network.publicIpAddresses[0].ipAddress}' --output tsv)
    ```

1.  运行以下脚本以呈现 Bash Shell 变量 ipAddress 的值：

    ```
    echo $ipAddress
    ```

1.  运行以下命令，通过使用安全外壳 (SSH) 工具和存储在 Bash Shell 变量 ipAddress 中的 IP 地址连接到之前在本实验室中创建的 VM：

    ```
    ssh student@$ipAddress
    ```

1.  但是，云更新经常发生，因此在此培训内容更新之前，可能会发生 UI 更改。

1.  如果发生这种情况，请适应这些更改，并根据需要在实验室中熟悉这些更改。

1.  使用 SSH 连接到 VM 后，运行以下命令，以获取描述 Linux VM 的元数据：

    ```
    uname -a
    ```

1.  使用**出口**命令结束 SSH 会话：

    ```
    exit
    ```

1.  关闭门户中的“Cloud Shell”窗格。

#### <a name="review"></a>审阅

在本练习中，你使用了 Cloud Shell 作为自动脚本的一部分创建 VM。

### <a name="exercise-2-create-a-docker-container-image-and-deploy-it-to-azure-container-registry"></a>练习 2：创建 Docker 容器映像并将其部署到 Azure 容器注册表

#### <a name="task-1-open-the-cloud-shell-and-editor"></a>任务 1：打开 Cloud Shell 和编辑器

1.  在 Azure 门户的导航窗格中，选择“Cloud Shell”图标，打开一个新的 shell 实例。  

    > **注意**：等待 Cloud Shell 完成连接到实例，再继续进行本实验室。

1.  在门户中的“Cloud Shell”命令提示符中，运行以下命令，以从根目录移动到 \~/clouddrive 目录：

    ```
    cd ~/clouddrive
    ```

1.  运行以下命令，以在 \~/clouddrive 目录中创建名为“ipcheck”的新目录：

    ```
    mkdir ipcheck
    ```

1.  运行以下命令，以将活动目录从 \~/clouddrive 更改为 \~/clouddrive/ipcheck：

    ```
    cd ~/clouddrive/ipcheck
    ```

1.  运行以下命令，以在当前目录中创建一个新的 .NET Core 控制台应用程序：

    ```
    dotnet new console --output . --name ipcheck --framework net6.0
    ```

1.  运行以下命令，以在名为 Dockerfile 的 \~/clouddrive/ipcheck 目录中创建一个新文件：

    ```
    touch Dockerfile
    ```

1.  运行以下命令，以在当前目录的上下文中打开嵌入式图形编辑器：

    ```
    code .
    ```

#### <a name="task-2-create-and-test-a-net-application"></a>任务 2：创建并测试 .NET 应用程序

1.  在图形编辑器中，在“文件”窗格上，选择“Program.cs”文件，以在编辑器中打开该文件。

1.  删除“Program.cs”文件的全部内容。

1.  将以下代码复制并粘贴到“Program.cs”文件中：

    ```csharp
    public class Program
    {
        public static void Main(string[] args)
        {        
            // Check if network is available
            if (System.Net.NetworkInformation.NetworkInterface.GetIsNetworkAvailable())
            {
                System.Console.WriteLine("Current IP Addresses:");

                // Get host entry for current hostname
                string hostname = System.Net.Dns.GetHostName();
                System.Net.IPHostEntry host = System.Net.Dns.GetHostEntry(hostname);
                
                // Iterate over each IP address and render their values
                foreach(System.Net.IPAddress address in host.AddressList)
                {
                    System.Console.WriteLine($"\t{address}");
                }
            }
            else
            {
                System.Console.WriteLine("No Network Connection");
            }
        }
    }
    ```

1.  Save the <bpt id="p1">**</bpt>Program.cs<ept id="p1">**</ept> file by using the menu in the graphical editor or the Ctrl+S keyboard shortcut.  Don't close the graphical editor.

1.  返回到命令提示符处，运行以下命令以运行应用程序：

    ```
    dotnet run
    ```

1.  Review the results of the run. At least one IP address should be listed for the Cloud Shell instance.

1.  在图形编辑器中，在编辑器的“文件”窗格上，选择“Dockerfile”文件，以在编辑器中打开该文件。

1.  将以下代码复制并粘贴到“Dockerfile”文件中：

    ```
    # Start using the .NET 6 SDK container image
    FROM mcr.microsoft.com/dotnet/sdk:6.0-alpine AS build

    # Change current working directory
    WORKDIR /app

    # Copy existing files from host machine
    COPY . ./

    # Publish application to the "out" folder
    RUN dotnet publish --configuration Release --output out

    # Start container by running application DLL
    ENTRYPOINT ["dotnet", "out/ipcheck.dll"]
    ```

1. 使用图形编辑器中的菜单或 Ctrl+S 键盘快捷键保存 **Dockerfile** 文件。

1. 让 Cloud Shell 保持打开状态，下一个任务中会用到。

#### <a name="task-3-create-a-container-registry-resource"></a>任务 3：创建 Azure 容器注册表资源

1. 在门户中的 Cloud Shell 命令提示符下，运行以下命令，以为容器注册表资源创建具有唯一值的变量： 

    ```bash
    registryName=conregistry$RANDOM
    ```

1. 在门户中的 Cloud Shell 命令提示符处，运行以下命令，以验证在上一步中创建的名称是否可用： 

    ```bash
    az acr check-name --name $registryName
    ```

    If the results show the name is available, continue to the next step. If the name is not available then re-run the command in the previous step and verify availability again.

1. 在门户中的 Cloud Shell 命令提示符处，运行以下命令，以创建容器注册表资源： 

    ```bash
    az acr create --resource-group ContainerCompute --name $registryName --sku Basic
    ```

    > **注意**：等待创建任务完成，再继续操作本实验室。

#### <a name="task-4-store-container-registry-metadata"></a>任务 4：存储容器注册表元数据

1.  在门户的 Cloud Shell 命令提示符中，运行以下命令，以查看订阅中的所有容器注册表列表：

    ```
    az acr list
    ```

1.  Run the following command, ensuring you see the name of your registry as output. If you see no output other than '[]', wait a minute and try running the command again.

    ```
    az acr list --query "max_by([], &creationDate).name" --output tsv
    ```

1.  运行以下命令：

    ```
    acrName=$(az acr list --query "max_by([], &creationDate).name" --output tsv)
    ```

1.  运行以下命令：

    ```
    echo $acrName
    ```

#### <a name="task-5-deploy-a-docker-container-image-to-container-registry"></a>任务 5：将 Docker 容器映像部署到容器注册表

1.  运行以下命令，以将活动目录从 \~/ 更改为 \~/clouddrive/ipcheck：

    ```
    cd ~/clouddrive/ipcheck
    ```

1.  运行以下命令以获取当前目录的内容：

    ```
    dir
    ```

1.  运行以下命令，以将源代码上传到容器注册表并将容器映像构建为容器注册表任务：

    ```
    az acr build --registry $acrName --image ipcheck:latest .
    ```

    > **注意**：等待生成任务完成后再继续本实验室。

1.  关闭门户中的“Cloud Shell”窗格。

#### <a name="task-6-validate-your-container-image-in-container-registry"></a>任务 6：在容器注册表中验证容器映像

1.  在 Azure 门户的“导航”窗格中，选择“资源组”链接。

1.  在“资源组”边栏选项卡中，选择你之前在本实验室中创建的“ContainerCompute”资源组。

1.  在“ContainerCompute”边栏选项卡中，选择你之前在本实验室中创建的容器注册表。

1.  在“容器注册表”边栏选项卡中，在“服务”部分中选择“存储库”链接。

1.  在“存储库”部分中，选择“ipcheck”容器映像存储库，然后选择“最新”标记。

1.  审阅具有“最新”标记的容器映像版本的元数据。

    > **注意**：你也可以选择“运行 ID”链接以查看有关生成任务的元数据。

#### <a name="review"></a>审阅

In this exercise, you created a .NET console application to display a machine’s current IP address. You then added the <bpt id="p1">**</bpt>Dockerfile<ept id="p1">**</ept> file to the application so that it could be converted into a Docker container image. Finally, you deployed the container image to Container Registry.

### <a name="exercise-3-deploy-an-azure-container-instance"></a>练习 3：部署 Azure 容器实例

#### <a name="task-1-enable-the-admin-user-in-container-registry"></a>任务 1：在容器注册表中启用管理员用户

1.  在 Azure 门户的“导航”窗格中，选择“资源组”链接。

1.  在“资源组”边栏选项卡中，选择你之前在本实验室中创建的“ContainerCompute”资源组。

1.  在“ContainerCompute”边栏选项卡中，选择你之前在本实验室中创建的容器注册表，然后选择“更新”。

1.  在“更新容器注册表”边栏选项卡中，在“管理员用户”部分中选择“启用”。

1.  选择“保存”，然后关闭“更新容器注册表”边栏选项卡。

#### <a name="task-2-automatically-deploy-a-container-image-to-an-azure-container-instance"></a>任务 2：自动将容器映像部署到 Azure 容器实例

1.  在“容器注册表”边栏选项卡中，在“服务”部分中选择“存储库”链接。

1.  在“存储库”部分，选择“ipcheck”容器映像存储库。

1.  在“存储库”边栏选项卡中，选择与“最新”标记条目关联的省略号菜单，然后选择“运行实例”。

1.  在“创建容器实例”边栏选项卡中，执行以下操作，然后选择“创建”：

    | 设置 | 操作 |
    | -- | -- |
    | “容器名称”文本框 | 输入“managedcompute” |
    | “容器映像”文本框 | 保留默认值 |
    | “OS 类型”部分 | 选择“Linux” |
    | “订阅”文本框 | 保留默认值 |
    | “资源组”下拉列表 | 选择“ContainerCompute” |
    | “位置”下拉列表 | 选择“美国东部” |
    | “核心数”下拉列表 | 选择“2” |
    | “内存 (GB)”文本框 | 输入“4” |
    | “公共 IP 地址”部分 | 请选择“否” |

    以下屏幕截图显示了“创建容器实例”边栏选项卡上配置的设置。

    ![“创建容器实例”边栏选项卡](./media/l05_create_container_instance.png)

    > **注意**：等待容器实例创建完成，再继续操作本实验室。

#### <a name="task-3-manually-deploy-a-container-image-to-container-instances"></a>任务 3：手动将容器映像部署到容器实例

1.  在 Azure 门户的“导航”窗格中，选择“创建资源”链接。

1.  在“创建资源”边栏选项卡的“搜索服务和市场”文本框中，输入“容器实例”  ，然后按 Enter 键。

1.  在“市场”搜索结果边栏选项卡中，选择“容器实例”结果。

1.  在“容器实例”边栏选项卡中，选择“创建”。

1.  在“创建容器实例”边栏选项卡的“基本信息”选项卡上，执行以下操作，然后选择“查看 + 创建”  ：

       | 设置 | 操作 |
       | -- | -- |
       | “订阅”下拉列表 | 保留默认值 |
       | “资源组”下拉列表 | 选择“ContainerCompute” |
       | “容器名称”文本框  | 输入“manualcompute” |
       | “区域”下拉列表 | 选择“(US)美国东部” |
       | “映像源”部分 | 选择“Azure 容器注册表” |
       | “注册表”下拉列表 | 选择你之前在本实验室中创建的“Azure 容器注册表”资源 |
       | “映像”下拉列表 | 选择“ipcheck” |
       | “映像标记”下拉列表 | 选择“最新” |

       以下屏幕截图显示了“创建容器实例”边栏选项卡上配置的设置。

       ![“创建容器实例”边栏选项卡](./media/l05_create_container_instance_manual.png)

1.  在“查看 + 创建”选项卡中，查看选定的选项。

1.  选择“创建”以使用指定配置创建容器实例。  

    > **注意**：等待容器实例创建完成，再继续操作本实验室。

#### <a name="task-4-validate-that-the-container-instance-ran-successfully"></a>任务 4：验证容器实例是否成功运行

1.  在 Azure 门户的导航窗格中，选择“资源组”链接。

1.  在“资源组”边栏选项卡中，选择你之前在本实验室中创建的“ContainerCompute”资源组。

1.  在“ContainerCompute”边栏选项卡中，选择你之前在本实验室中创建的 manualcompute 容器实例。

1.  在“容器实例”边栏选项卡中，在“设置”部分中选择“容器”链接。

1.  在“容器”部分中，查看“事件”列表。

1.  选择“日志”选项卡，然后查看容器实例中的短信日志。

> **注意**：你也可以选择查看 managedcompute 容器实例中的“事件”和“日志”。

> 注意：此时 manualcompute 和 managedcompute 可能不包含任何事件。 

> <bpt id="p1">**</bpt>Note<ept id="p1">**</ept>: After the application finishes running, the container terminates because it has completed its work. For the manually created container instance, you indicated that a successful exit was acceptable, so the container ran once. The automatically created instance didn't offer this option, and it assumes the container should always be running, so you'll notice repeated restarts of the container.

#### <a name="review"></a>审阅

In this exercise, you used multiple methods to deploy a container image to an Azure container instance. By using the manual method, you were able to customize the deployment further and to run task-based applications as part of a container run.

### <a name="exercise-4-clean-up-your-subscription"></a>练习 4：清理订阅

#### <a name="task-1-open-azure-cloud-shell-and-list-resource-groups"></a>任务 1：打开 Azure Cloud Shell 并列出资源组

1.  In the Azure portal, select the <bpt id="p1">**</bpt>Cloud Shell<ept id="p1">**</ept> icon <ph id="ph1">![</ph>Cloud Shell icon<ph id="ph2">](./media/az204_lab_CloudShell.png)</ph> to open a new Bash session. If Cloud Shell defaults to a PowerShell session, select <bpt id="p1">**</bpt>PowerShell<ept id="p1">**</ept>, and then in the drop-down menu, select <bpt id="p2">**</bpt>Bash<ept id="p2">**</ept>.

    > <bpt id="p1">**</bpt>Note<ept id="p1">**</ept>: If this is the first time you're starting <bpt id="p2">**</bpt>Cloud Shell<ept id="p2">**</ept>, when prompted to select either <bpt id="p3">**</bpt>Bash<ept id="p3">**</ept> or <bpt id="p4">**</bpt>PowerShell<ept id="p4">**</ept>, select <bpt id="p5">**</bpt>PowerShell<ept id="p5">**</ept>. When you're presented with the <bpt id="p1">**</bpt>You have no storage mounted<ept id="p1">**</ept> message, select the subscription you're using in this lab, and then select <bpt id="p2">**</bpt>Create storage<ept id="p2">**</ept>.

#### <a name="task-2-delete-resource-groups"></a>任务 2：删除资源组

1.  在“Cloud Shell”窗格中，运行以下命令以删除“ContainerCompute”资源组： 

    ```
    az group delete --name ContainerCompute --no-wait --yes
    ```

   > **注意**：该命令以异步方式执行（由 --nowait 参数确定），因此，尽管可立即在同一个 Bash 会话中运行另一个 Azure CLI 命令，但实际上要花几分钟才能删除资源组。

1. 关闭门户中的“Cloud Shell”窗格。

#### <a name="task-3-close-the-active-applications"></a>任务 3：关闭活动应用程序

-   关闭当前正在运行的 Microsoft Edge 应用程序。

#### <a name="review"></a>审阅

在本练习中，你通过删除本实验室中使用的资源组清理了订阅。
