---
lab:
    az204Title: '实验室 09：发布和订阅事件网格事件'
    az020Title: '实验室 09：发布和订阅事件网格事件'
    az204Module: '模块 09：开发基于事件的解决方案'
    az020Module: '模块 09：开发基于事件的解决方案'
---

# 实验室 09：发布和订阅事件网格事件

## Microsoft Azure 用户界面

鉴于 Microsoft 云工具的动态特性，Azure UI 在此培训内容开发后可能会发生更改。因此，实验室说明和实验室步骤可能无法完全一致。

当社区提醒我们进行必要的更改时，Microsoft 会更新本培训课程。然而，云更新的发生频率很高，因此你可能会遇到 UI 已更改但本培训内容尚未更新的情况。 **如果发生这种情况，请适应这些更改，并根据需要在实验室中熟悉这些更改。**

## 说明

### 准备工作

#### 登录实验室环境

使用以下凭据登录 Windows 10 虚拟机 (VM)：

- 用户名：**Admin**

- 密码： **Pa55w.rd**

> **备注**：你的讲师将提供连接到虚拟实验室环境的说明。

#### 查看已安装的应用程序

在你的 Windows 10 桌面上找到任务栏。任务栏里有本实验室中你将使用的应用程序的图标，包括：

- Microsoft Edge

- Microsoft Visual Studio Code

## 体系结构图

![描述用户发布和订阅事件网格事件的体系结构图。](./media/Lab09-Diagram.png)

### 练习 1：创建 Azure 资源

#### 任务 1：打开 Azure 门户

1. 在任务栏上，选择 **Microsoft Edge** 图标。

1. 在打开的浏览器窗口中，浏览到 Azure 门户 (<https://portal.azure.com>)，然后使用你将在本实验室中使用的帐户登录。

    > **备注**：第一次登录 Azure 门户时，你会看到一个门户教程。选择“**开始使用**”，跳过教程并开始使用门户。

#### 任务 2：打开 Azure Cloud Shell

1. 在 Azure 门户中，选择 **Cloud Shell** 图标 ![Cloud Shell 图标](./media/az204_lab_CloudShell.png)，打开新的 Bash 会话。如果 Cloud Shell 默认为 PowerShell 会话，请选择“**PowerShell**”，然后在下拉菜单中选择“**Bash**”。

    > **备注**：首次启动 **Cloud Shell** 时，系统会提示选择 **Bash** 或 **PowerShell**，请选择“**Bash**”。如果显示“**未挂载存储**”消息，请选择你在本实验室中使用的订阅，然后选择“**创建存储**”。

1. 在 Azure 门户中的 **Cloud Shell** 命令提示符处，运行以下命令以获取 Azure 命令行界面 (Azure CLI) 工具的版本：

    ```bash
    az --version
    ```

#### 任务 3：查看 Microsoft.EventGrid 提供程序注册

1. 在门户中的 **Cloud Shell** 命令提示符处，执行以下操作：

    a. 运行以下命令以获取 Azure CLI 根级别的子组和命令列表：

    ```bash
    az --help
    ```

    b. 运行以下命令以获取可用于资源提供程序的命令列表：

    ```bash
    az provider --help
    ```

    c. 运行以下命令以列出所有当前注册的提供程序：

   ```bash
   az provider list
   ```

    d. 运行以下命令以仅列出当前注册的提供程序的命名空间：

   ```bash
   az provider list --query "[].namespace"
   ```

    e. 查看当前注册的提供程序列表。请注意，**Microsoft.EventGrid** 提供程序当前包含在提供程序列表中。

1. 关闭 **Cloud Shell** 窗格。

#### 任务 4：创建自定义事件网格主题

1. 在 Azure 门户的导航窗格中，选择“**创建资源**”。

1. 在“**创建资源**”边栏选项卡上的“**搜索服务和市场**”文本框中，输入“**事件网格主题**”，然后按 Enter。

1. 在“**市场**”搜索结果边栏选项卡上，选择“**事件网格主题**”结果，然后选择“**创建**”。

1. 在“**创建主题**”边栏选项卡上的“**基本信息**”选项卡上，执行以下操作，然后选择“**高级**”选项卡：

    | 设置                           | 操作                                                       |
    | --------------------------------- | ------------------------------------------------------------ |
    | “**订阅**”下拉列表   | 保留默认值。                                    |
    | “**资源组**”下拉列表 | 选择“**新建**”，输入 **PubSubEvents**，然后选择“**确定**”。 |
    | “**名称**”文本框                 | 输入 **hrtopic**_[yourname]_。                               |
    | “**区域**”下拉列表         | 选择“**美国东部**”。                                          |

   以下屏幕截图显示了“**基本信息**”选项卡上的已配置设置。

   ![屏幕截图显示了“创建主题”边栏选项卡上的已配置设置](./media/l09_create_topic.png)

1. 在“**高级**”选项卡上的“**事件架构**”下拉列表中，选择“**事件网格架构**”，然后选择“**查看 + 创建**”。

1. 在“**查看 + 创建**”选项卡中，查看你在前面的步骤中选择的选项。

1. 选择“**创建**”以使用指定配置创建事件网格主题。
  
    > **备注**：等待 Azure 完成创建主题，再继续本实验室操作。创建主题时会收到通知。

#### 任务 5：将 Azure 事件网格查看器部署到 Web 应用

1. 在 Azure 门户的导航窗格中，选择“**创建资源**”。

1. 在“**创建资源**”边栏选项卡上的“**搜索服务和市场**”文本框中，输入“**Web 应用**”，然后按 Enter。

1. 在“**市场**”搜索结果边栏选项卡上，选择“**Web 应用**”结果，然后选择“**创建**”。

1. 在“**创建 Web 应用**”边栏选项卡上的“**基本信息**”选项卡上，执行以下操作，然后选择“**下一步: Docker**”：

   | 设置                           | 操作                                                       |
   | --------------------------------- | ------------------------------------------------------------ |
   | “**订阅**”下拉列表   | 保留默认值。                                    |
   | “**资源组**”下拉列表 | 在列表中选择“**PubSubEvents**”。                         |
   | “**名称**”文本框                 | 输入 **eventviewer**_[yourname]_。                           |
   | “**发布**”部分               | 选择“**Docker 容器**”。                                 |
   | “**操作系统**”部分      | 选择“**Linux**”。                                            |
   | “**区域**”下拉列表         | 选择“**美国东部**”。                                          |
   | “**Linux 计划(美国东部)**”部分  | 选择“**新建**”，在“**名称**”文本框中输入 **EventPlan**，然后选择“**确定**”。 |
   | “**SKU 和大小**”部分          | 保留默认值。                                    |

   以下屏幕截图显示了“**创建 Web 应用**”边栏选项卡上的已配置设置。

   ![屏幕截图显示了“创建 Web 应用”边栏选项卡上的已配置设置](./media/l09_create_web_app.png)

1. 在“**Docker**”选项卡上执行以下操作，然后选择“**查看 + 创建**”：

    | 设置                         | 操作                                                      |
    | ------------------------------- | ----------------------------------------------------------- |
    | “**选项**”下拉列表      | 选择“**单个容器**”。                                |
    | “**映像源**”下拉列表 | 选择“**Docker Hub**”。                                      |
    | “**访问类型**”下拉列表  | 选择“**公共**”。                                          |
    | “**映像和标记**”文本框      | 输入 **microsoftlearning/azure-event-grid-viewer:latest**。 |

   以下屏幕截图显示了“**Docker**”选项卡上的已配置设置。

   ![屏幕截图显示了“创建 Web 应用 - Docker”选项卡上的已配置设置](./media/l09_create_web_app_docker.png)

1. 在“**查看 + 创建**”选项卡中，查看你在前面的步骤中选择的选项。

1. 选择“**创建**”，使用指定的配置创建 Web 应用。
  
    > **备注**：等待 Azure 完成 Web 应用的创建后再继续本实验室。你将会在应用创建完毕后收到通知。

#### 回顾

在本练习中，你创建了在本实验剩余时间里将用到的“事件网格主题”和“Web 应用”。

### 练习 2：创建事件网格订阅

#### 任务 1：访问事件网格查看器 Web 应用程序

1. 在 Azure 门户的导航窗格中，选择“**资源组**”。

1. 在“**资源组**”边栏选项卡上，选择“**PubSubEvents**”资源组。

1. 在“**PubSubEvents**”边栏选项卡上，选择 **eventviewer**_[yourname]_ Web 应用。

1. 在“**应用服务**”边栏选项卡的“**设置**”**部分，选择“属性**”链接。

1. 在“**属性**”部分中，记录“**URL**”链接的值。你将在稍后的实验室中使用此值。

1. 依次选择“**概述**”、“**浏览**”。

1. 查看当前运行的“**Azure 事件网格查看器**”Web 应用程序。在接下来的实验室中，请保持 Web 应用程序的运行状态。

    > **备注**：此 Web 应用程序会随着事件发送到其终结点实时更新。你将使用此应用程序来监视整个实验室的事件。

1. 返回显示 Azure 门户的当前打开的浏览器窗口。

#### 任务 2：创建新订阅

1. 在 Azure 门户的导航窗格中，选择“**资源组**”。

1. 在“**资源组**”边栏选项卡上，选择你在本实验室前面部分创建的“**PubSubEvents**”资源组。

1. 在“**PubSubEvents**”边栏选项卡上，选择你在本实验室前面部分创建的 **hrtopic**_[yourname]_ 事件网格主题。

1. 在“**事件网格主题**”边栏选项卡上，选择“**+ 事件订阅**”。

1. 在“**创建事件订阅**”边栏选项卡上执行以下操作，然后选择“**创建**”：

    | 设置                          | 操作                                                       |
    | -------------------------------- | ------------------------------------------------------------ |
    | “**名称**”文本框                | 输入 **basicsub**。                                          |
    | “**事件架构**”下拉列表  | 选择“**事件网格架构**”。                                |
    | “**终结点类型**”下拉列表 | 选择“**Webhook**”。                                         |
    | **终结点**                     | 选择“**选择终结点**”。在“**订阅者终结点**”文本框中，输入你之前记录的 **Web 应用 URL** 值，确保其使用 **https://** 作为前缀，添加“**/api/updates**”作为后缀，然后选择“**确认选择**”。例如，如果你的 **Web 应用 URL** 值为 ``http://eventviewerstudent.azurewebsites.net/``，那么“**订阅终结点**”将是 ``https://eventviewerstudent.azurewebsites.net/api/updates``。 |

   以下屏幕截图显示了“**创建事件订阅**”边栏选项卡上的已配置设置。

   ![屏幕截图显示了“创建事件订阅”边栏选项卡上的已配置设置](./media/l09_create_event_subscription.png)

    > **备注**：等待 Azure 完成创建订阅再继续本实验室操作。创建订阅时会收到通知。

#### 任务 3：观察订阅验证事件

1. 返回到显示 **Azure 事件网格查看器** Web 应用程序的浏览器窗口。

1. 查看在订阅创建过程中创建的 **Microsoft.EventGrid.SubscriptionValidationEvent** 事件。

1. 选择事件并查看其 JSON 内容。

1. 返回到当前打开显示 Azure 门户的浏览器窗口。

#### 任务 4：记录订阅凭据

1. 在 Azure 门户的导航窗格中，选择“**资源组**”。

1. 在“**资源组**”边栏选项卡上，选择你在本实验室前面部分创建的“**PubSubEvents**”资源组。

1. 在“**PubSubEvents**”边栏选项卡上，选择你在本实验室前面部分创建的 **hrtopic**_[yourname]_ 事件网格主题。

1. 在“**事件网格主题**”边栏选项卡中，记录“**主题终结点**”字段的值。你将在稍后的实验室中使用此值。

1. 在“**设置**”类别中，选择“**访问密钥**”链接。

1. 在“**访问密钥**”部分，记录“**密钥 1**”文本框的值。你将在稍后的实验室中使用此值。

#### 回顾

在本练习中，你创建了一个新的订阅并进行了注册验证，然后记录了将新事件发布到该主题所需的凭据。

### 练习 3：在 .NET 上发布事件网格事件

#### 任务 1：创建 .NET 项目

1. 在“**启动**”屏幕上，选择“**Visual Studio Code**”磁贴。

1. 在“**文件**”菜单上，选择“**打开文件夹**”。

1. 在打开的“**文件资源管理器**”窗口中，前往 **Allfiles (F):\\Allfiles\\Labs\\09\\Starter\\EventPublisher**，然后选择“**选择文件夹**”。

1. 在 **Visual Studio Code** 窗口中，激活“**资源管理器**”窗格的快捷菜单，然后选择“**在集成终端中打开**”。

1. 运行以下命令，在当前文件夹中创建一个名为 **EventPublisher** 的新 .NET 项目：

    ```powershell
    dotnet new console --name EventPublisher --output .
    ```

    > **备注**：**dotnet new** 命令将在与项目同名的文件夹中创建一个新的控制台项目。

1. 运行以下命令，从 NuGet 导入 4.1.0 版 **Azure.Messaging.EventGrid**：

    ```powershell
    dotnet add package Azure.Messaging.EventGrid --version 4.1.0
    ```

    > **备注**：**dotnet add package** 命令将从 NuGet 中添加 **Microsoft.Azure.EventGrid** 包。有关详细信息，请转到 [Azure.Messaging.EventGrid](https://www.nuget.org/packages/Azure.Messaging.EventGrid/4.1.0)。

1. 运行以下命令，生成 .NET Web 应用程序：

    ```powershell
    dotnet build
    ```

1. 选择“**终止终端**”或者“**回收站**”图标以关闭当前打开的终端和所有关联的进程。

#### 任务 2：修改 Program 类以连接到事件网格

1. 在 **Visual Studio Code** 窗口的“**资源管理器**”窗格中，打开 **Program.cs** 文件。

1. 在 **Program.cs** 文件的代码编辑器选项卡中，删除现有文件中的所有代码。

1. 添加以下代码行，通过从 NuGet 导入的 **Azure.Messaging.EventGrid** 包导入 **Azure** 和 **Azure.Messaging.EventGrid** 命名空间：

    ```csharp
    using Azure;
    using Azure.Messaging.EventGrid;
    ```

1. 添加以下代码行，为此文件将使用的内置命名空间添加 **using** 指令：

    ```csharp
    using System;
    using System.Threading.Tasks;
    ```

1. 输入以下代码，创建一个新的 **Program** 类：

    ```csharp
    public class Program
    {
    }
    ```

1. 在 **Program** 类中，输入以下代码行以创建一个名为 **topicEndpoint** 的新字符串常量：

    ```csharp
    private const string topicEndpoint = "";
    ```

1. 更新 **topicEndpoint** 字符串常量，将其值设置为你在本实验室前面部分记录的事件网格主题的主题终结点。

1. 在 **Program** 类中，输入以下代码行以创建一个名为 **topicKey** 的新字符串常量：

    ```csharp
    private const string topicKey = "";
    ```

1. 更新 **topicKey** 字符串常量，将其值设置为你在本实验室前面部分记录的事件网格主题的键。

1. 在 **Program** 类中，输入以下代码以创建新的异步 **Main** 方法：

    ```csharp
    public static async Task Main(string[] args)
    {
    }
    ```

1. 查看 **Program.cs** 文件，该文件中现在应该包含以下代码行：

    ```csharp
    using System;
    using System.Threading.Tasks;
    using Azure;
    using Azure.Messaging.EventGrid;
    
    public class Program
    {
        private const string topicEndpoint = "<topic-endpoint>";
        private const string topicKey = "<topic-key>";
        
        public static async Task Main(string[] args)
        {
        }
    }
    ```

#### 任务 3：发布新事件

1. 在 **Main** 方法中，执行以下操作以将事件列表发布到你的主题终结点：

    a. 添加以下代码行，将 **topicEndpoint** 字符串常量用作构造函数参数，创建一个名为 **endpoint** 的 **URI** 类型的新变量。

    ```csharp
    Uri endpoint = new Uri(topicEndpoint); 
    ```

    b. 添加以下代码行，将 **topicKey** 字符串常量用作构造函数参数，创建一个名为 **credential** 的 **[[AzureKeyCredential](https://docs.microsoft.com/dotnet/api/azure.azurekeycredential)]** 类型的新变量。

    ```csharp
    AzureKeyCredential credential = new AzureKeyCredential(topicKey);
    ```

    c. 添加以下代码行，将 **endpoint** 和 **credential** 变量用作构造函数参数，创建一个名为 **client** 的 **[[EventGridPublisherClient](https://docs.microsoft.com/dotnet/api/azure.messaging.eventgrid.eventgridpublisherclient)]** 类型的新变量。

    ```csharp
    EventGridPublisherClient client = new EventGridPublisherClient(endpoint, credential);
    ```

    d. 添加以下代码块，创建一个名为 **firstEvent** 的 **[[EventGridEvent](https://docs.microsoft.com/dotnet/api/azure.messaging.eventgrid.eventgridevent)]** 类型的新变量，并为该变量填充样本数据：

    ```csharp
    EventGridEvent firstEvent = new EventGridEvent(
        subject: $"New Employee: Alba Sutton",
        eventType: "Employees.Registration.New",
        dataVersion: "1.0",
        data: new
        {
            FullName = "Alba Sutton",
            Address = "4567 Pine Avenue, Edison, WA 97202"
         }
     );
     ```

    e. 添加以下代码块，创建一个名为 **secondEvent** 的 **[[EventGridEvent](https://docs.microsoft.com/dotnet/api/azure.messaging.eventgrid.eventgridevent)]** 类型的新变量，并为该变量填充样本数据：

     ```csharp
        EventGridEvent secondEvent = new EventGridEvent(
            subject: $"New Employee: Alexandre Doyon",
            eventType: "Employees.Registration.New",
            dataVersion: "1.0",
            data: new
            {
                FullName = "Alexandre Doyon",
                Address = "456 College Street, Bow, WA 98107"
            }
        );
     ```

    f. 添加以下代码行，使用 **firstEvent** 变量作为参数来异步调用 **[[EventGridPublisherClient.SendEventAsync](https://docs.microsoft.com/dotnet/api/azure.messaging.eventgrid.eventgridpublisherclient.sendeventasync)]** 方法。

     ```csharp
     await client.SendEventAsync(firstEvent);
     ```

    g. 添加以下代码行，在控制台中显示消息“**已发布第一个事件**”：

     ```csharp
     Console.WriteLine("First event published");
     ```

    h. 添加以下代码行，使用 **secondEvent** 变量作为参数来异步调用 **[[EventGridPublisherClient.SendEventAsync](https://docs.microsoft.com/dotnet/api/azure.messaging.eventgrid.eventgridpublisherclient.sendeventasync)]** 方法。

     ```csharp
     await client.SendEventAsync(secondEvent);
     ```

    i. 添加以下代码行，在控制台中显示消息“**已发布第二个事件**”：

     ```csharp
     Console.WriteLine("Second event published");
     ```

1. 查看 **Main** 方法，其中现在应包括：

    ```csharp
    public static async Task Main(string[] args)
    {
        Uri endpoint = new Uri(topicEndpoint);
        AzureKeyCredential credential = new AzureKeyCredential(topicKey);
        EventGridPublisherClient client = new EventGridPublisherClient(endpoint, credential);
        
        EventGridEvent firstEvent = new EventGridEvent(
            subject: $"New Employee: Alba Sutton",
            eventType: "Employees.Registration.New",
            dataVersion: "1.0",
            data: new
            {
                FullName = "Alba Sutton",
                Address = "4567 Pine Avenue, Edison, WA 97202"
            }
        );

        EventGridEvent secondEvent = new EventGridEvent(
            subject: $"New Employee: Alexandre Doyon",
            eventType: "Employees.Registration.New",
            dataVersion: "1.0",
            data: new
            {
                FullName = "Alexandre Doyon",
                Address = "456 College Street, Bow, WA 98107"
            }
        );

        await client.SendEventAsync(firstEvent);
        Console.WriteLine("First event published");

        await client.SendEventAsync(secondEvent);
        Console.WriteLine("Second event published");
    }
    ```

1. 保存 **Program.cs** 文件。

1. 在 **Visual Studio Code** 窗口中，激活“**资源管理器**”窗格的快捷菜单，然后选择“**在集成终端中打开**”。

1. 运行以下命令以运行 .NET Web 应用程序：

    ```powershell
    dotnet run
    ```

    > **备注**：如果出现任何生成错误，请查看 **Allfiles (F):\\Allfiles\\Labs\\09\\Solution\\EventPublisher** 文件夹中的 **Program.cs** 文件。

1. 观察从当前正在运行的控制台应用程序中输出的成功消息。

1. 选择“**终止终端**”或者“**回收站**”图标以关闭当前打开的终端和所有关联的进程。

#### 任务 4：查看发布的事件

1. 返回到 **Azure 事件网格查看器** Web 应用程序的浏览器窗口。

1. 查看由控制台应用程序创建的 **Employees.Registration.New** 事件。

1. 选择任何事件并查看其 JSON 内容。

1. 返回 Azure 门户。

#### 回顾

在本练习中，你已使用 .NET 控制台应用程序将新事件发布到事件网格主题。

### 练习 4：清理订阅

#### 任务 1：打开 Azure Cloud Shell

1. 在 Azure 门户中，选择 **Cloud Shell** 图标 ![Cloud Shell 图标](./media/az204_lab_CloudShell.png)，打开新的 Bash 会话。如果 Cloud Shell 默认为 PowerShell 会话，请选择“**PowerShell**”，然后在下拉菜单中选择“**Bash**”。

    > **备注**：首次启动 **Cloud Shell** 时，系统会提示选择 **Bash** 或 **PowerShell**，请选择“**PowerShell**”。如果显示“**未挂载存储**”消息，请选择你在本实验室中使用的订阅，然后选择“**创建存储**”。

#### 任务 2：删除资源组

1. 在 **Cloud Shell** 窗格上运行以下命令，以删除 **PubSubEvents** 资源组：

    ```bash
    az group delete --name PubSubEvents --no-wait --yes
    ```

     > **备注**：该命令以异步方式运行（由 *[--no-wait]* 参数确定），因此，尽管可立即在同一 Bash 会话中运行另一个 Azure CLI 命令，但实际上要花几分钟才能删除资源组。

1. 关闭门户中的 **Cloud Shell** 窗格。

#### 任务 3：关闭活动应用程序

1. 关闭当前正在运行的 Microsoft Edge 应用程序。

1. 关闭当前正在运行的“Visual Studio Code”应用程序。

#### 回顾

在本练习中，你通过删除本实验室中使用的资源组清理订阅。
